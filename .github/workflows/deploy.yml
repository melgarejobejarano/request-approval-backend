name: Deploy Backend via CloudFormation (Infra + App)

on:
  push:
    branches:
      - main

env:
  AWS_REGION: eu-central-1

jobs:
  deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout code
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # 2. Setup Node.js
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # -----------------------------------------------------------------------
      # 3. Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # 4. Build backend
      # -----------------------------------------------------------------------
      - name: Build backend
        run: npm run build

      # -----------------------------------------------------------------------
      # 5. Create Lambda ZIP package
      # -----------------------------------------------------------------------
      - name: Create Lambda deployment package
        run: |
          echo "Packaging Lambda code..."
          mkdir -p package
          cp -r dist/* package/
          cp -r node_modules package/
          cd package
          zip -qr ../deployment-${{ github.sha }}.zip .
          cd ..
          rm -rf package
          ls -lh deployment-${{ github.sha }}.zip

      # -----------------------------------------------------------------------
      # 6. Configure AWS credentials
      # -----------------------------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------------------------------------------------
      # 7. Deploy INFRASTRUCTURE stack (S3, DynamoDB, etc.)
      # -----------------------------------------------------------------------
      - name: Deploy infrastructure stack
        run: |
          echo "Deploying infrastructure stack..."
          aws cloudformation deploy \
            --template-file cloudformation/infra.yml \
            --stack-name client-requests-infra \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset

      # -----------------------------------------------------------------------
      # 8. Get artifacts bucket from infra stack outputs
      # -----------------------------------------------------------------------
      - name: Get Lambda artifacts bucket
        run: |
          BUCKET=$(aws cloudformation describe-stacks \
            --stack-name client-requests-infra \
            --query "Stacks[0].Outputs[?OutputKey=='ArtifactsBucket'].OutputValue" \
            --output text)

          if [ -z "$BUCKET" ]; then
            echo "ERROR: Could not retrieve artifacts bucket"
            exit 1
          fi

          echo "Using artifacts bucket: $BUCKET"
          echo "LAMBDA_BUCKET=$BUCKET" >> $GITHUB_ENV

      # -----------------------------------------------------------------------
      # 9. Upload Lambda ZIP to S3 (bucket created by infra)
      # -----------------------------------------------------------------------
      - name: Upload Lambda ZIP to S3
        run: |
          ZIP_KEY=deployment-${{ github.sha }}.zip
          echo "Uploading $ZIP_KEY to s3://$LAMBDA_BUCKET"
          aws s3 cp \
            deployment-${{ github.sha }}.zip \
            s3://$LAMBDA_BUCKET/$ZIP_KEY

      # -----------------------------------------------------------------------
      # 10. Deploy APPLICATION stack (Lambdas)
      # -----------------------------------------------------------------------
      - name: Deploy application stack
        run: |
          echo "Deploying application stack..."
          aws cloudformation deploy \
            --template-file cloudformation/app.yml \
            --stack-name client-requests-app \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              LambdaS3Bucket=$LAMBDA_BUCKET \
              LambdaS3Key=deployment-${{ github.sha }}.zip

      # -----------------------------------------------------------------------
      # 11. Show outputs
      # -----------------------------------------------------------------------
      - name: Show deployment outputs
        run: |
          echo "Fetching outputs..."

          TABLE=$(aws cloudformation describe-stacks \
            --stack-name client-requests-infra \
            --query "Stacks[0].Outputs[?OutputKey=='DynamoTable'].OutputValue" \
            --output text)

          echo "----------------------------------------"
          echo "DEPLOYMENT SUCCESSFUL"
          echo "----------------------------------------"
          echo "Artifacts bucket: $LAMBDA_BUCKET"
          echo "DynamoDB table:   $TABLE"
          echo "----------------------------------------"