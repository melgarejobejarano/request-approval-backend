# =============================================================================
# Client Request & Approval System - CloudFormation Deployment
# =============================================================================
#
# This workflow:
# - Builds the backend
# - Packages Lambda code into a ZIP
# - Uploads the ZIP to S3
# - Deploys infrastructure using AWS CloudFormation
#
# This setup is:
# - Reproducible
# - Auditable
# - Enterprise-ready
# - Aligned with CI/CD best practices
#
# =============================================================================

name: Deploy Backend via CloudFormation

# -----------------------------------------------------------------------------
# Trigger: Push to main branch
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - main

# -----------------------------------------------------------------------------
# Global Environment Variables
# -----------------------------------------------------------------------------
env:
  AWS_REGION: eu-central-1
  ENVIRONMENT: production
  STACK_NAME: client-requests-production

# -----------------------------------------------------------------------------
# Prevent concurrent deployments
# -----------------------------------------------------------------------------
concurrency:
  group: cloudformation-deploy
  cancel-in-progress: false

# -----------------------------------------------------------------------------
# Jobs
# -----------------------------------------------------------------------------
jobs:
  deploy:
    name: Build and Deploy Backend
    runs-on: ubuntu-latest

    steps:
      # =========================================================================
      # STEP 1: Checkout repository
      # =========================================================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # =========================================================================
      # STEP 2: Setup Node.js
      # =========================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # =========================================================================
      # STEP 3: Install dependencies
      # =========================================================================
      - name: Install dependencies
        run: npm ci

      # =========================================================================
      # STEP 4: Build backend
      # =========================================================================
      - name: Build backend
        run: npm run build

      # =========================================================================
      # STEP 5: Create Lambda deployment package
      # =========================================================================
      - name: Create deployment package
        run: |
          echo "Creating Lambda deployment package..."

          mkdir -p package

          # Copy compiled code
          cp -r dist/* package/

          # Copy dependencies
          cp -r node_modules package/

          # Create ZIP file
          cd package
          zip -qr ../deployment-${{ github.sha }}.zip .
          cd ..

          # Cleanup
          rm -rf package

          echo "Deployment package created:"
          ls -lh deployment-${{ github.sha }}.zip

      # =========================================================================
      # STEP 6: Configure AWS credentials
      # =========================================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # =========================================================================
      # STEP 7: Upload deployment package to S3
      # =========================================================================
      - name: Upload deployment package to S3
        run: |
          S3_KEY="deployment-${{ github.sha }}.zip"

          echo "Uploading Lambda package to S3..."
          echo "Bucket: ${{ secrets.LAMBDA_S3_BUCKET }}"
          echo "Key:    ${S3_KEY}"

          aws s3 cp \
            deployment-${{ github.sha }}.zip \
            s3://${{ secrets.LAMBDA_S3_BUCKET }}/${S3_KEY}

          echo "Upload completed"

      # =========================================================================
      # STEP 8: Validate CloudFormation template
      # =========================================================================
      - name: Validate CloudFormation template
        run: |
          echo "Validating CloudFormation template..."
          aws cloudformation validate-template \
            --template-body file://cloudformation/template.yml
          echo "Template is valid"

      # =========================================================================
      # STEP 9: Deploy CloudFormation stack
      # =========================================================================
      - name: Deploy CloudFormation stack
        run: |
          S3_KEY="deployment-${{ github.sha }}.zip"

          echo "========================================"
          echo "Deploying CloudFormation stack"
          echo "========================================"
          echo "Stack Name:  ${{ env.STACK_NAME }}"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "S3 Bucket:   ${{ secrets.LAMBDA_S3_BUCKET }}"
          echo "S3 Key:      ${S3_KEY}"
          echo "========================================"

          aws cloudformation deploy \
            --template-file cloudformation/template.yml \
            --stack-name ${{ env.STACK_NAME }} \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-fail-on-empty-changeset \
            --parameter-overrides \
              Environment="${{ env.ENVIRONMENT }}" \
              LambdaS3Bucket="${{ secrets.LAMBDA_S3_BUCKET }}" \
              LambdaS3Key="${S3_KEY}" \
              AllowedOrigins="*" \
            --tags \
              Environment="${{ env.ENVIRONMENT }}" \
              Application="ClientRequestApprovalSystem" \
              ManagedBy="GitHubActions" \
              CommitSHA="${{ github.sha }}"

          echo "CloudFormation deployment completed"

      # =========================================================================
      # STEP 10: Display stack outputs
      # =========================================================================
      - name: Get deployment outputs
        run: |
          echo "Retrieving stack outputs..."

          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='ApiGatewayUrl'].OutputValue" \
            --output text)

          TABLE_NAME=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='DynamoDBTableName'].OutputValue" \
            --output text)

          echo ""
          echo "========================================"
          echo "DEPLOYMENT SUCCESSFUL"
          echo "========================================"
          echo "API URL:        ${API_URL}"
          echo "DynamoDB Table: ${TABLE_NAME}"
          echo "========================================"

          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Backend Deployment Complete

          | Output | Value |
          |-------|-------|
          | **API URL** | \`${API_URL}\` |
          | **DynamoDB Table** | \`${TABLE_NAME}\` |
          | **Stack Name** | \`${{ env.STACK_NAME }}\` |
          | **Commit** | \`${{ github.sha }}\` |

          ### Available API Endpoints

          | Method | Path | Description |
          |-------|------|-------------|
          | POST | /requests | Create client request |
          | GET | /requests | List requests |
          | GET | /requests/{id} | Get request by ID |
          | PATCH | /requests/{id}/estimate | Estimate request |
          | PATCH | /requests/{id}/approve | Approve request |
          EOF