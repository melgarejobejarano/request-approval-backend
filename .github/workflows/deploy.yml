AWSTemplateFormatVersion: '2010-09-09'
Description: Client Request & Approval System Backend

Parameters:
  Environment:
    Type: String
    Default: production

  LambdaS3Bucket:
    Type: String
    Default: ''
    Description: Optional S3 bucket for Lambda artifacts

  LambdaS3Key:
    Type: String
    Default: ''
    Description: Optional S3 key for Lambda artifacts

  AllowedOrigins:
    Type: String
    Default: '*'

Conditions:
  UseProvidedLambdaArtifacts: !And
    - !Not [!Equals [!Ref LambdaS3Bucket, '']]
    - !Not [!Equals [!Ref LambdaS3Key, '']]

Resources:
  # ---------------------------------------------------------------------------
  # S3 Bucket for Lambda artifacts (created only if not provided)
  # ---------------------------------------------------------------------------
  LambdaArtifactsBucket:
    Type: AWS::S3::Bucket
    Condition: !Not [UseProvidedLambdaArtifacts]
    Properties:
      BucketName: !Sub '${AWS::StackName}-lambda-artifacts'
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ---------------------------------------------------------------------------
  # IAM Role for Lambda execution
  # ---------------------------------------------------------------------------
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${AWS::StackName}-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess

  # ---------------------------------------------------------------------------
  # Example Lambda (repeat pattern for others)
  # ---------------------------------------------------------------------------
  CreateRequestFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${AWS::StackName}-create-request'
      Runtime: nodejs18.x
      Handler: CreateRequest.handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Code:
        S3Bucket: !If
          - UseProvidedLambdaArtifacts
          - !Ref LambdaS3Bucket
          - !Ref LambdaArtifactsBucket
        S3Key: !If
          - UseProvidedLambdaArtifacts
          - !Ref LambdaS3Key
          - 'bootstrap.zip'
      Timeout: 30
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment

Outputs:
  LambdaArtifactsBucketName:
    Description: S3 bucket used for Lambda artifacts
    Value: !If
      - UseProvidedLambdaArtifacts
      - !Ref LambdaS3Bucket
      - !Ref LambdaArtifactsBucket